let jsonObj;function index_body_stock_init(){getAllCommodities();searchBtnListenerRegister();updateCinfoModelInit()}function searchBtnListenerRegister(){$("#stock-selectForm").on("submit",function(a){a.preventDefault();let brand=$("#select-brandInput").val();let name=$("#select-nameInput").val();let model=$("#select-modelInput").val();let standard=$("#select-standardInput").val();jsonObj={brand:brand,name:name,model:model,standard:standard};if(brand===""&&name===""&&model===""&&standard===""){alert("请输入条件")}else{if(brand!==""&&name!==""){if(model!==""&&standard!==""){getCommoditiesByAll()}else{if(model!==""&&standard===""){getCommoditiesByBrandNameModel()}else{getCommoditiesByBrandName()}}}else{if(brand!==""&&name===""){getCommoditiesByBrand()}else{if(brand===""&&name!==""){getCommoditiesByName()}else{alert("请至少输入品牌或品名查询！")}}}}});$("#stock-selectForm button:eq(1)").on("click",function(){getAllCommodities()})}function getAllCommodities(){$.ajax({url:"getAllCommodities",type:"get",async:true,dataType:"json",success:function(a){showCommmodities(a)},error:function(a){alert("----ajax请求所有商品出错！错误信息如下：----\n"+a.responseText)}})}function getCommoditiesByAll(){$.ajax({url:"getCommoditiesByAll",type:"post",data:JSON.stringify(jsonObj),contentType:"application/json;charset=utf-8",async:true,dataType:"json",success:function(a){showCommmodities(a)},error:function(a){alert("----ajax请求所有条件查询商品出错！错误信息如下：----\n"+a.responseText)}})}function getCommoditiesByBrand(){$.ajax({url:"getCommoditiesByBrand",type:"post",data:JSON.stringify({brand:jsonObj.brand}),contentType:"application/json;charset=utf-8",async:true,dataType:"json",success:function(a){showCommmodities(a)},error:function(a){alert("----ajax请求按品牌查询商品出错！错误信息如下：----\n"+a.responseText)}})}function getCommoditiesByName(){$.ajax({url:"getCommoditiesByName",type:"post",data:JSON.stringify({name:jsonObj.name}),contentType:"application/json;charset=utf-8",async:true,dataType:"json",success:function(a){showCommmodities(a)},error:function(a){alert("----ajax请求按品名查询商品出错！错误信息如下：----\n"+a.responseText)}})}function getCommoditiesByBrandName(){$.ajax({url:"getCommoditiesByBrandName",type:"post",data:JSON.stringify({brand:jsonObj.brand,name:jsonObj.name}),contentType:"application/json;charset=utf-8",async:true,dataType:"json",success:function(a){showCommmodities(a)},error:function(a){alert("----ajax请求按品牌品名查询商品出错！错误信息如下：----\n"+a.responseText)}})}function getCommoditiesByBrandNameModel(){$.ajax({url:"getCommoditiesByBrandNameModel",type:"post",data:JSON.stringify({brand:jsonObj.brand,name:jsonObj.name,model:jsonObj.model}),contentType:"application/json;charset=utf-8",async:true,dataType:"json",success:function(a){showCommmodities(a)},error:function(a){alert("----ajax请求按品牌品名型号查询商品出错！错误信息如下：----\n"+a.responseText)}})}function showCommmodities(a){if(isLoaded("allCommodities-tbody")){$("#allCommodities-tbody").remove()}let html="<tbody id='allCommodities-tbody'>";$.each(a,function(b,c){if(c.stock<=3){html+="<tr class='danger'>"}else{html+="<tr>"}html+="<td>"+c.cid+"</td><td>"+c.brand+"</td><td>"+c.name+"</td><td>"+c.model+"</td><td>"+c.standard+"</td><td>"+c.stock+"</td><td>"+c.oprice+"</td><td class='operation'><button type='button' class='btn btn-primary btn-sm' onclick='deleteCommodity(this)'>删除</button><button type='button' class='btn btn-primary btn-sm' onclick='updateCinfo(this)'>更改信息</button><button type='button' class='btn btn-primary btn-sm' onclick='addCart(this)'>添加购物车</button></td><td>"+c.iprice+"</td></tr>"});if(html==="<tbody id='allCommodities-tbody'>"){$("#noCommodityTip").show()}else{$("#noCommodityTip").hide();$("#allCommodities-table").append(html)}}function updateCinfo(a){let tr=$(a).parent().parent();let cinfo={cid:$(tr).children("td:eq(0)").text(),brand:$(tr).children("td:eq(1)").text(),name:$(tr).children("td:eq(2)").text(),model:$(tr).children("td:eq(3)").text(),standard:$(tr).children("td:eq(4)").text(),stock:$(tr).children("td:eq(5)").text(),oprice:$(tr).children("td:eq(6)").text(),iprice:$(tr).children("td:eq(8)").text()};$("#updateCinfoForm legend").text(cinfo.cid);$("#update-brandInput").val(cinfo.brand);$("#update-nameInput").val(cinfo.name);$("#update-modelInput").val(cinfo.model);$("#update-standardInput").val(cinfo.standard);$("#update-stockInput").val(cinfo.stock);$("#update-opriceInput").val(cinfo.oprice);$("#update-ipriceInput").val(cinfo.iprice);$("#updateCinfoModal").modal()}function updateCinfoModelInit(){$("#updateCinfoForm").bootstrapValidator({message:"*输入不合法",feedbackIcons:{valid:"glyphicon glyphicon-ok",invalid:"glyphicon glyphicon-remove",validating:"glyphicon glyphicon-refresh"},fields:{"update-brandInput":{message:"*品牌不合法",validators:{notEmpty:{message:"*品牌不能为空"}}},"update-nameInput":{message:"*名称不合法",validators:{notEmpty:{message:"*名称不能为空"}}},"update-modelInput":{validators:{callback:{callback:function(){return true}}}},"update-standardInput":{validators:{callback:{callback:function(){return true}}}},"update-stockInput":{message:"*库存不合法",validators:{notEmpty:{message:"*库存不能为空"},regexp:{regexp:/^[0-9]+$/,message:"*库存只能为正整数"}}},"update-opriceInput":{message:"*单价不合法",validators:{notEmpty:{message:"*单价不能为空"},regexp:{regexp:/^[0-9]+(\.?[0-9]+)?$/,message:"*单价只能为正整数或含小数的正整数"}}},"update-ipriceInput":{message:"*进价不合法",validators:{notEmpty:{message:"*进价不能为空"},regexp:{regexp:/^[0-9]+(\.?[0-9]+)?$/,message:"*进价只能为正整数或含小数的正整数"}}}}});$("#updateCinfoModal .modal-footer button:eq(1)").on("click",function(){let validator=$("#updateCinfoForm").data("bootstrapValidator");validator.validate();if(validator.isValid()){let newCinfo=JSON.stringify({cid:$("#updateCinfoForm legend").text(),newbrand:$("#update-brandInput").val(),newname:$("#update-nameInput").val(),newmodel:$("#update-modelInput").val(),newstandard:$("#update-standardInput").val(),newstock:$("#update-stockInput").val(),newoprice:$("#update-opriceInput").val(),newiprice:$("#update-ipriceInput").val()});$.ajax({url:"updateCinfo",type:"post",data:newCinfo,contentType:"application/json;charset=utf-8",async:true,dataType:"json",success:function(a){alert("更改成功！");getAllCommodities();$("#updateCinfoModal").modal("hide")},error:function(a){alert("----ajax请求更新商品信息出错！错误信息如下：----\n"+a.responseText)}})}else{alert("请正确填写商品信息!")}});$("#updateCinfoModal").on("hide.bs.modal",function(a){let validator=$("#updateCinfoForm").data("bootstrapValidator");validator.resetForm("true")})}function deleteCommodity(a){let cid=$(a).parent().parent().children("td:eq(0)").text();$.ajax({url:"deleteCommodity",type:"post",data:JSON.stringify({cid:cid}),contentType:"application/json;charset=utf-8",async:true,dataType:"json",success:function(b){alert("删除成功！");getAllCommodities()},error:function(b){alert("----ajax请求删除商品出错！错误信息如下：----\n"+b.responseText)}})}function addCart(a){let tr=$(a).parent().parent();let cid=$(tr).children("td:eq(0)").text();let stock=$(tr).children("td:eq(5)").text();let iprice=parseFloat($(tr).children("td:eq(8)").text());let oprice=$(tr).children("td:eq(6)").text();if(stock==="0"){alert("库存不足！");return}let exist=false;$.each(clist,function(b,c){if(c.cid===cid){exist=true;if(c.num<parseInt(c.stock)){c.num++;c.lprice=(parseFloat(c.oprice)*c.discount*c.num).toFixed(2);c.dprice=(parseFloat(c.oprice)*c.num-parseFloat(c.lprice)).toFixed(2)}else{alert("库存不足！")}return false}});if(!exist){let cinfo={cid:cid,brand:$(tr).children("td:eq(1)").text(),name:$(tr).children("td:eq(2)").text(),model:$(tr).children("td:eq(3)").text(),standard:$(tr).children("td:eq(4)").text(),stock:stock,iprice:iprice,oprice:oprice,discount:"1.00",num:1,lprice:oprice,dprice:"0.00"};clist.push(cinfo)}};