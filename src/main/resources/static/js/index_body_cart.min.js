let total=0;let totaldiscount=0;let discountSelect="<option value='1.00'>不打折</option><option value='0.95'>95折</option><option value='0.9'>9折</option><option value='0.85'>85折</option><option value='0.8'>8折</option><option value='0.75'>75折</option><option value='0.7'>7折</option><option value='0.65'>65折</option><option value='0.6'>6折</option><option value='0.55'>55折</option><option value='0.5'>5折</option></select>";function index_body_cart_init(){loadCart()}function loadCart(){if(isLoaded("cart-tbody")){$("#cart-tbody").remove()}let html="<tbody id='cart-tbody'>";$.each(clist,function(a,b){let no=a+1;html+="<tr> <td>"+no+"</td><td>"+b.cid+"—"+b.brand+"—"+b.name+"—"+b.model+"—"+b.standard+"</td><td><input type='number' value='"+b.num+"' min='1' max='"+b.stock+"' onchange='littleCount(this, "+a+", 0)' onkeydown='return false;'></td><td>"+b.oprice+"</td><td><select onchange='littleCount(this, "+a+", 1)'>"+discountSelect+"</td><td>"+b.lprice+"</td><td>- "+b.dprice+"</td><td class='operation'><button type='button' class='btn btn-primary btn-sm' onclick='deleteCartCommodity(this, "+a+")'>删除</button></td></tr>"});if(html==="<tbody id='cart-tbody'>"){$("#cartEmptyTip").show();$("#markInputArea").hide()}else{$("#cartEmptyTip").hide();$("#cart-table").append(html);$("#markInputArea").show()}count()}function deleteCartCommodity(a,b){$(a).parent().parent().remove();clist.splice(b,1);loadCart()}function littleCount(a,b,c){if(c===0){clist[b].num=$(a).val();clist[b].lprice=(parseFloat(clist[b].oprice)*clist[b].discount*clist[b].num).toFixed(2);clist[b].dprice=(parseFloat(clist[b].oprice)*clist[b].num-parseFloat(clist[b].lprice)).toFixed(2);$(a).parent().next().next().next().text(clist[b].lprice);$(a).parent().next().next().next().next().text("-"+clist[b].dprice)}else{clist[b].discount=$(a).val();clist[b].lprice=(parseFloat(clist[b].oprice)*parseFloat(clist[b].discount)*clist[b].num).toFixed(2);clist[b].dprice=(parseFloat(clist[b].oprice)*clist[b].num-parseFloat(clist[b].lprice)).toFixed(2);$(a).parent().next().text(clist[b].lprice);$(a).parent().next().next().text("-"+clist[b].dprice)}count()}function count(){total=0;totaldiscount=0;$.each(clist,function(a,b){total+=parseFloat(b.lprice);totaldiscount+=parseFloat(b.dprice)});total=total.toFixed(2);totaldiscount=totaldiscount.toFixed(2);$("#totalprice").text("合计："+total+" 元");$("#totaldiscount").text("优惠：- "+totaldiscount+" 元");if(total==="0.00"){$("#purchase").attr("disabled","disabled")}else{$("#purchase").removeAttr("disabled")}}function purchase(){let mark=$("#markInput").val();if(mark===""){if(confirm("确定不用备注吗？")){a(mark)}else{$("#markInput").focus()}}else{if(confirm("确定结算吗？")){a(mark)}}function a(b){let time=new Date().getTime();let oid="#"+timestampToTime(time,1);let income=0;$.each(clist,function(c,d){income+=parseFloat(d.lprice)-d.iprice*d.num});let orderInfo={oid:oid,time:time,mark:b,tprice:total,tdisprice:totaldiscount,income:income.toFixed(2),clist:clist};$.ajax({url:"purchase",type:"post",data:JSON.stringify(orderInfo),contentType:"application/json;charset=utf-8",async:false,dataType:"json",success:function(c){if(confirm("购买成功！订单号为："+oid+"，是否打印订单？")){saveData2Ses({oid:oid});window.open("porder","_blank")}clist=[];total="0.00";totaldiscount="0.00";loadCart()},error:function(c){alert("----ajax请求购买出错！错误信息如下：----\n"+c.responseText)}})}};